pipeline {
    agent any
       
       stages{
         stage('GCP Cred'){
            steps{
                 withCredentials([file(credentialsId: 'gcp-key', variable: 'GC_KEY')]) {
            sh("gcloud auth activate-service-account --key-file=${GC_KEY}")
               }
        }
}
        stage('Terraform Apply') {
            steps {
                script {
                    sh 'terraform init'
                    sh 'terraform apply -auto-approve'
                }
        }
        }

stage('Build Docker Image') {
            steps {
                script {
                    sh 'gcloud auth configure-docker europe-central2-docker.pkg.dev'
                    sh 'echo "https://europe-central2-docker.pkg.dev" | docker-credential-gcloud get'
                    sh 'docker build -t eu.gcr.io/tf-gcp-connection/my-app:latest .'
                    sh 'gcloud auth print-access-token | docker login -u oauth2accesstoken --password-stdin https://europe-central2-docker.pkg.dev'
                    sh 'docker push eu.gcr.io/tf-gcp-connection/my-app:latest'
                }
            }
        }


        
        stage('Ansible Provision') {
            steps {
                script {
                    sh 'ansible-playbook -i inventory playbook.yml'
                }
            }
        }
  }
}
